#!/usr/bin/env python3
"""
DeepResearch Ã— LangManus - æ°—è±¡ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
"""

import argparse
import asyncio
import os
from pathlib import Path
from datetime import datetime

try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    print("Warning: python-dotenv not installed. Please set environment variables manually.")

def setup_logging():
    """ãƒ­ã‚°è¨­å®šã®åˆæœŸåŒ–"""
    try:
        from loguru import logger
        log_level = os.getenv("LOG_LEVEL", "INFO")
        logger.remove()
        logger.add(
            "logs/app_{time:YYYY-MM-DD}.log",
            rotation="1 day",
            retention="30 days",
            level=log_level,
            format="{time:YYYY-MM-DD HH:mm:ss} | {level} | {name}:{function}:{line} | {message}"
        )
        logger.add(
            lambda msg: print(msg, end=""),
            level=log_level,
            format="<green>{time:HH:mm:ss}</green> | <level>{level}</level> | {message}"
        )
        return logger
    except ImportError:
        print("Warning: loguru not installed. Using basic logging.")
        import logging
        logging.basicConfig(level=logging.INFO)
        return logging.getLogger(__name__)

def setup_output_directory():
    """å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ"""
    output_dir = Path(os.getenv("OUTPUT_DIR", "./outputs"))
    output_dir.mkdir(exist_ok=True)
    
    # ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ä½œæˆ
    (output_dir / "reports").mkdir(exist_ok=True)
    (output_dir / "data").mkdir(exist_ok=True)
    (output_dir / "charts").mkdir(exist_ok=True)
    
    return output_dir

async def run_weather_research(query: str, location: str, output_format: str = "report"):
    """æ°—è±¡ç ”ç©¶ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ"""
    logger = setup_logging()
    logger.info(f"Starting weather research for query: {query}")
    logger.info(f"Location: {location}, Output format: {output_format}")
    
    try:
        # TODO: Implement the actual workflow
        # workflow = WeatherResearchWorkflow()
        # result = await workflow.run(query=query, location=location)
        
        # For now, return a placeholder
        result = {
            "query": query,
            "location": location,
            "status": "success",
            "message": "Weather research workflow completed successfully",
            "timestamp": datetime.now().isoformat(),
            "output_format": output_format
        }
        
        print("âœ… Weather research completed successfully")
        return result
        
    except Exception as e:
        print(f"âŒ Error in weather research workflow: {e}")
        raise

def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="DeepResearch Ã— LangManus - æ°—è±¡ãƒ‡ãƒ¼ã‚¿æ¢ç´¢ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"
    )
    
    parser.add_argument(
        "--query",
        type=str,
        required=True,
        help="ç ”ç©¶ã‚¯ã‚¨ãƒªï¼ˆä¾‹ï¼š'éå»5å¹´é–“ã®é¦–éƒ½åœã«ãŠã‘ã‚‹çŒ›æš‘æ—¥ã¨ç†±ä¸­ç—‡é–¢é€£ã®å¯¾ç­–ã‚’èª¿ã¹ã¦'ï¼‰"
    )
    
    parser.add_argument(
        "--location",
        type=str,
        default="Tokyo,JP",
        help="å¯¾è±¡åœ°åŸŸï¼ˆä¾‹ï¼š'Tokyo,JP', 'Osaka,JP'ï¼‰"
    )
    
    parser.add_argument(
        "--output-format",
        type=str,
        choices=["report", "dashboard", "json"],
        default="report",
        help="å‡ºåŠ›å½¢å¼"
    )
    
    parser.add_argument(
        "--debug",
        action="store_true",
        help="ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
    )
    
    args = parser.parse_args()
    
    # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š
    if args.debug:
        os.environ["DEBUG"] = "true"
        os.environ["LOG_LEVEL"] = "DEBUG"
    
    # åˆæœŸåŒ–
    output_dir = setup_output_directory()
    
    print("ğŸš€ DeepResearch Ã— LangManus - Starting weather research project")
    print(f"ğŸ“ Output directory: {output_dir.absolute()}")
    
    # éåŒæœŸå®Ÿè¡Œ
    try:
        result = asyncio.run(
            run_weather_research(
                query=args.query,
                location=args.location,
                output_format=args.output_format
            )
        )
        
        # çµæœã®å‡ºåŠ›
        output_file = output_dir / "reports" / f"{datetime.now().strftime('%Y%m%d_%H%M')}_report.md"
        
        with open(output_file, "w", encoding="utf-8") as f:
            f.write(f"# Weather Research Report\n\n")
            f.write(f"**Query:** {result['query']}\n\n")
            f.write(f"**Location:** {result['location']}\n\n")
            f.write(f"**Status:** {result['status']}\n\n")
            f.write(f"**Timestamp:** {result['timestamp']}\n\n")
            f.write(f"**Message:** {result['message']}\n\n")
            f.write("---\n\n")
            f.write("*Generated by DeepResearch Ã— LangManus*\n")
        
        print(f"ğŸ“„ Report generated: {output_file}")
        
    except KeyboardInterrupt:
        print("âš ï¸  Process interrupted by user")
    except Exception as e:
        print(f"ğŸ’¥ Fatal error: {e}")
        return 1
    
    return 0

if __name__ == "__main__":
    exit(main())
